<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tracker - Grid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Shared Navbar -->
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Crypto Tracker</h1>
            <div class="flex space-x-4">
                <a href="index.html" class="hover:bg-blue-700 px-3 py-2 rounded">Grid</a>
                <a href="coin.html" class="hover:bg-blue-700 px-3 py-2 rounded">Detail</a>
                <a href="tracker.html" class="hover:bg-blue-700 px-3 py-2 rounded">Tracker</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Cryptocurrency Grid</h2>
            <p class="text-gray-600">Browse and search cryptocurrencies</p>
        </div>

        <!-- Search Box -->
        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="Search by name or symbol..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-2 text-gray-600">Loading cryptocurrencies...</p>
        </div>

        <!-- Grid Container -->
        <div id="coinsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 hidden">
            <!-- Coins will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-8 hidden">
            <p class="text-gray-600">No cryptocurrencies found matching your search.</p>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // API Configuration - Multiple providers with fallbacks
        const API_PROVIDERS = [
            {
                name: 'cryptocompare',
                baseUrl: 'https://min-api.cryptocompare.com/data',
                marketUrl: 'https://min-api.cryptocompare.com/data/pricemultifull?fsyms=BTC,ETH,USDT,SOL,MNT&tsyms=USD',
                useProxy: false
            },
            {
                name: 'coingecko',
                baseUrl: 'https://api.codetabs.com/v1/proxy?quest=https://api.coingecko.com/api/v3',
                marketUrl: 'https://api.codetabs.com/v1/proxy?quest=https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false&price_change_percentage=24h',
                useProxy: true
            }
        ];

        let currentApiProvider = 0;

        // API functions
        // Fallback sample data when API is unavailable
        function getSampleCoinsData() {
            return [
                {
                    id: 'bitcoin',
                    symbol: 'btc',
                    name: 'Bitcoin',
                    image: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                    current_price: 43250.75,
                    market_cap: 847500000000,
                    price_change_percentage_24h: 2.45
                },
                {
                    id: 'ethereum',
                    symbol: 'eth',
                    name: 'Ethereum',
                    image: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                    current_price: 2650.32,
                    market_cap: 318900000000,
                    price_change_percentage_24h: -1.23
                },
                {
                    id: 'tether',
                    symbol: 'usdt',
                    name: 'Tether',
                    image: 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                    current_price: 1.00,
                    market_cap: 91500000000,
                    price_change_percentage_24h: 0.01
                },
                {
                    id: 'solana',
                    symbol: 'sol',
                    name: 'Solana',
                    image: 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                    current_price: 98.45,
                    market_cap: 45200000000,
                    price_change_percentage_24h: 5.67
                },
                {
                    id: 'mantle',
                    symbol: 'mnt',
                    name: 'Mantle',
                    image: 'https://assets.coingecko.com/coins/images/30980/large/token-logo.png',
                    current_price: 0.85,
                    market_cap: 2750000000,
                    price_change_percentage_24h: 12.34
                }
            ];
        }

        async function listMarkets() {
            // Try each API provider in sequence
            for (let i = currentApiProvider; i < API_PROVIDERS.length; i++) {
                try {
                    const provider = API_PROVIDERS[i];
                    console.log(`Trying ${provider.name} API...`);

                    const response = await fetch(provider.marketUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(`Raw response from ${provider.name}:`, data);

                    // Transform data based on provider
                    const transformedData = await transformApiData(data, provider.name);
                    console.log(`Successfully loaded ${transformedData.length} coins from ${provider.name}`);

                    // If successful, update current provider and return data
                    currentApiProvider = i;
                    return transformedData;

                } catch (error) {
                    console.warn(`${API_PROVIDERS[i].name} API failed:`, error.message);
                    continue;
                }
            }

            // If all APIs fail, throw error
            throw new Error('All API providers failed');
        }

        async function transformApiData(data, providerName) {
            if (providerName === 'cryptocompare') {
                // Transform CryptoCompare format to match our expected format
                if (data.RAW && data.RAW.USD) {
                    return Object.entries(data.RAW.USD).map(([symbol, coinData]) => ({
                        id: symbol.toLowerCase(),
                        symbol: symbol.toLowerCase(),
                        name: symbol.toUpperCase(),
                        image: `https://assets.coingecko.com/coins/images/1/large/${symbol.toLowerCase()}.png`, // Placeholder
                        current_price: coinData.PRICE,
                        market_cap: coinData.MKTCAP,
                        price_change_percentage_24h: coinData.CHANGEPCT24HOUR
                    }));
                }
            } else if (providerName === 'coingecko') {
                // Handle CoinGecko format (existing logic)
                if (data && data.status && data.status.error_code) {
                    throw new Error(`API Error ${data.status.error_code}: ${data.status.error_message || 'Unknown error'}`);
                }

                if (data && typeof data === 'object' && data.status && !Array.isArray(data)) {
                    throw new Error(`API returned error status: ${JSON.stringify(data.status)}`);
                }

                if (!Array.isArray(data)) {
                    throw new Error('API did not return expected data format');
                }

                return data;
            }

            throw new Error(`Unknown provider: ${providerName}`);
        }

        // Toast notification system
        function showNotification(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || (() => {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'fixed top-4 right-4 z-50 space-y-2';
                document.body.appendChild(container);
                return container;
            })();

            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' :
                            type === 'success' ? 'bg-green-500' : 'bg-blue-500';

            toast.className = `${bgColor} text-white px-4 py-2 rounded shadow-lg transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">Ã—</button>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // UI functions
        function renderCoinsGrid(coins) {
            const grid = document.getElementById('coinsGrid');
            if (!grid) return;

            // Ensure coins is an array
            if (!Array.isArray(coins)) {
                console.error('Coins data is not an array:', coins);
                showNotification('Error: Invalid data format received', 'error');
                return;
            }

            if (coins.length === 0) {
                showNotification('No coins data available', 'info');
                return;
            }

            grid.innerHTML = coins.map(coin => `
                <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow">
                    <div class="flex items-center mb-2">
                        <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 mr-2">
                        <div>
                            <h3 class="font-bold text-gray-800">${coin.name}</h3>
                            <p class="text-gray-600 text-sm">${coin.symbol.toUpperCase()}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-green-600">$${coin.current_price.toLocaleString()}</span>
                        <span class="text-sm ${coin.price_change_percentage_24h >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${coin.price_change_percentage_24h >= 0 ? '+' : ''}${coin.price_change_percentage_24h.toFixed(2)}%
                        </span>
                    </div>
                    <button onclick="addToFavorites('${coin.id}')" class="w-full bg-blue-600 text-white py-1 rounded text-sm hover:bg-blue-700">
                        Add to Tracker
                    </button>
                </div>
            `).join('');
        }

        // Favorites management
        const FAVORITES_KEY = 'crypto_favorites';
        const MAX_FAVORITES = 5;

        function getFavorites() {
            return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || [];
        }

        function addToFavorites(coinId) {
            const favorites = getFavorites();
            if (favorites.includes(coinId)) {
                showNotification('Coin already in favorites', 'info');
                return;
            }
            if (favorites.length >= MAX_FAVORITES) {
                showNotification(`Maximum ${MAX_FAVORITES} favorites allowed`, 'error');
                return;
            }
            favorites.push(coinId);
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
            showNotification('Added to favorites!', 'success');
        }

        function isMaxFavorites() {
            return getFavorites().length >= MAX_FAVORITES;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const startTime = Date.now();
                let coins = await listMarkets();
                const loadTime = Date.now() - startTime;

                // Use sample data if API fails or returns empty data
                if (!coins || coins.length === 0) {
                    console.warn('Using sample data due to API issues');
                    coins = getSampleCoinsData();
                    showNotification('Using demo data - All APIs unavailable', 'warning');
                } else {
                    const provider = API_PROVIDERS[currentApiProvider];
                    showNotification(`Loaded ${coins.length} coins from ${provider.name} (${loadTime}ms)`, 'success');
                }

                renderCoinsGrid(coins);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('coinsGrid').classList.remove('hidden');

                // Add search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const coinElements = document.querySelectorAll('#coinsGrid > div');

                    coinElements.forEach(coin => {
                        const name = coin.querySelector('h3').textContent.toLowerCase();
                        const symbol = coin.querySelector('p').textContent.toLowerCase();
                        const isMatch = name.includes(searchTerm) || symbol.includes(searchTerm);
                        coin.style.display = isMatch ? 'block' : 'none';
                    });
                });
            } catch (error) {
                console.error('Error initializing page:', error);
                // Use sample data as fallback
                console.warn('Using sample data due to error:', error.message);
                const coins = getSampleCoinsData();
                renderCoinsGrid(coins);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('coinsGrid').classList.remove('hidden');
                showNotification('Using demo data - All APIs failed', 'warning');
            }
        });
    </script>
</body>
</html>
