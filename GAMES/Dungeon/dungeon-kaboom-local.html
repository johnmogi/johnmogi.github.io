<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Master RPG - Kaboom.js Edition (CORS Fixed)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }
        #gameCanvas {
            border: 2px solid #333;
            background: #000;
            display: block;
            margin: 0 auto;
        }
        .game-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
        }
        .stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            min-width: 200px;
        }
        .health-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin: 5px 0;
        }
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff8800, #ffff00);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .mana-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin: 5px 0;
        }
        .mana-fill {
            height: 100%;
            background: linear-gradient(90deg, #0088ff, #00aaff, #00ffff);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .pixel-font {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .glow {
            text-shadow: 0 0 10px currentColor;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="game-info pixel-font">
        <div>FPS: <span id="fps" class="text-green-400">0</span></div>
        <div>Objects: <span id="objects" class="text-blue-400">0</span></div>
        <div>Engine: <span class="text-yellow-400">Kaboom.js</span></div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div class="controls pixel-font">
        <h3 class="text-yellow-400 glow mb-2">��� CONTROLS</h3>
        <div class="space-y-1 text-sm">
            <div><kbd class="bg-gray-700 px-2 py-1 rounded text-green-400">W</kbd><kbd class="bg-gray-700 px-2 py-1 rounded text-green-400">A</kbd><kbd class="bg-gray-700 px-2 py-1 rounded text-green-400">S</kbd><kbd class="bg-gray-700 px-2 py-1 rounded text-green-400">D</kbd> Move</div>
            <div><kbd class="bg-gray-700 px-2 py-1 rounded text-red-400">SPACE</kbd> Attack</div>
            <div><kbd class="bg-gray-700 px-2 py-1 rounded text-blue-400">E</kbd> Interact</div>
            <div><kbd class="bg-gray-700 px-2 py-1 rounded text-purple-400">I</kbd> Inventory</div>
        </div>
    </div>
    
    <div class="stats pixel-font">
        <h3 class="text-yellow-400 glow mb-2">��� HERO STATS</h3>
        <div id="heroStats" class="space-y-1 text-sm">
            <div>Loading hero data...</div>
        </div>
        
        <div class="mt-3">
            <div class="text-red-400 mb-1">❤️ HEALTH</div>
            <div class="health-bar">
                <div class="health-fill" id="healthFill" style="width: 100%"></div>
            </div>
            <div id="healthText" class="text-center text-red-400">100/100</div>
        </div>
        
        <div class="mt-2">
            <div class="text-blue-400 mb-1">��� MANA</div>
            <div class="mana-bar">
                <div class="mana-fill" id="manaFill" style="width: 100%"></div>
            </div>
            <div id="manaText" class="text-center text-blue-400">50/50</div>
        </div>
    </div>

    <!-- Kaboom.js loaded from CDN - NO CORS ISSUES -->
    <script src="https://unpkg.com/kaboom/dist/kaboom.js"></script>
    
    <script>
        // Initialize Kaboom - CORS FREE!
        kaboom({
            global: true,
            fullscreen: false,
            scale: 1,
            debug: true,
            clearColor: [0, 0, 0, 1],
            width: 1200,
            height: 800,
            canvas: document.querySelector("#gameCanvas"),
        });

        // Game state - NO EXTERNAL DEPENDENCIES
        window.gameState = {
            hero: null,
            monsters: [],
            gameData: null,
            score: 0,
            level: 1,
            cameraLocked: true
        };

        // Game data - ALL INLINE
        const gameData = {
            heroNames: ['Aragorn', 'Legolas', 'Gimli', 'Frodo', 'Gandalf', 'Eowyn', 'Boromir'],
            races: ['Human', 'Elf', 'Dwarf', 'Hobbit', 'Half-Elf'],
            classes: ['Fighter', 'Wizard', 'Rogue', 'Cleric', 'Ranger', 'Barbarian'],
            monsterNames: ['Goblin', 'Orc', 'Dragon', 'Skeleton', 'Troll', 'Spider', 'Ghost'],
            monsterTypes: ['Undead', 'Beast', 'Dragon', 'Humanoid', 'Elemental'],
            abilities: ['Fire Breath', 'Magic Missile', 'Sword Strike', 'Poison Bite', 'Life Drain'],
            items: [
                { name: 'Sword of Flames', type: 'weapon', rarity: 'legendary', damage: 20 },
                { name: 'Ring of Invisibility', type: 'accessory', rarity: 'rare' },
                { name: 'Health Potion', type: 'consumable', rarity: 'common', healing: 50 }
            ],
            rooms: [
                'Empty Room', 'Treasure Room', 'Monster Lair', 'Trap Room', 
                'Library', 'Armory', 'Altar Room', 'Garden'
            ]
        };

        // Utility functions - ALL INLINE
        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomItems(array, count) {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function distance(a, b) {
            return Math.sqrt(Math.pow(a.pos.x - b.pos.x, 2) + Math.pow(a.pos.y - b.pos.y, 2));
        }

        // Generate hero - ALL INLINE
        function generateHero() {
            const name = getRandomItem(gameData.heroNames);
            const race = getRandomItem(gameData.races);
            const characterClass = getRandomItem(gameData.classes);
            
            return {
                name,
                race,
                characterClass,
                level: 1,
                xp: 0,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                stats: {
                    str: Math.floor(Math.random() * 6) + 10,
                    dex: Math.floor(Math.random() * 6) + 10,
                    int: Math.floor(Math.random() * 6) + 10,
                    wis: Math.floor(Math.random() * 6) + 10
                },
                x: 100,
                y: 100,
                inventory: [],
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory: null
                }
            };
        }

        // Generate monster - ALL INLINE
        function generateMonster(x = 400, y = 200) {
            const name = getRandomItem(gameData.monsterNames);
            const type = getRandomItem(gameData.monsterTypes);
            
            return {
                name,
                type,
                level: Math.floor(Math.random() * 3) + 1,
                hp: 30 + (Math.random() * 20),
                maxHp: 30 + (Math.random() * 20),
                abilities: getRandomItems(gameData.abilities, 2),
                x: x,
                y: y,
                speed: 50 + Math.random() * 50,
                damage: 5 + Math.random() * 15
            };
        }

        // Sprite definitions - ALL INLINE (NO EXTERNAL FILES)
        const heroSprite = `
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#4A90E2" rx="4"/>
          <circle cx="12" cy="12" r="2" fill="#000"/>
          <circle cx="20" cy="12" r="2" fill="#000"/>
          <path d="M10 20 Q16 24 22 20" stroke="#000" stroke-width="2" fill="none"/>
          <rect x="8" y="8" width="16" height="16" fill="none" stroke="#FFD700" stroke-width="1"/>
        </svg>
        `;

        const monsterSprite = `
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#E74C3C" rx="4"/>
          <circle cx="10" cy="10" r="2" fill="#000"/>
          <circle cx="22" cy="10" r="2" fill="#000"/>
          <rect x="8" y="18" width="4" height="6" fill="#000"/>
          <rect x="12" y="20" width="2" height="4" fill="#FFF"/>
          <rect x="18" y="20" width="2" height="4" fill="#FFF"/>
          <rect x="20" y="18" width="4" height="6" fill="#000"/>
        </svg>
        `;

        const wallSprite = `
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#666" rx="2"/>
          <rect x="0" y="0" width="16" height="16" fill="#777" rx="1"/>
          <rect x="16" y="16" width="16" height="16" fill="#777" rx="1"/>
          <rect x="8" y="8" width="4" height="4" fill="#555"/>
          <rect x="20" y="4" width="4" height="4" fill="#555"/>
        </svg>
        `;

        const floorSprite = `
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#8B4513" rx="1"/>
          <rect x="0" y="0" width="16" height="16" fill="#A0522D"/>
          <rect x="16" y="16" width="16" height="16" fill="#A0522D"/>
          <circle cx="8" cy="8" r="1" fill="#654321"/>
          <circle cx="24" cy="24" r="1" fill="#654321"/>
        </svg>
        `;

        const treasureSprite = `
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#FFD700" rx="4"/>
          <polygon points="16,8 20,16 16,20 12,16" fill="#FFA500"/>
          <circle cx="16" cy="12" r="2" fill="#FF4500"/>
        </svg>
        `;

        const potionSprite = `
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#00FF00" rx="4"/>
          <ellipse cx="16" cy="16" rx="12" ry="8" fill="#32CD32"/>
          <path d="M8 16 Q16 8 24 16" stroke="#228B22" stroke-width="2" fill="none"/>
        </svg>
        `;

        // Convert SVG to data URL
        function svgToDataURL(svg) {
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }

        // Load sprites - ALL INLINE
        loadSprite("hero", svgToDataURL(heroSprite));
        loadSprite("monster", svgToDataURL(monsterSprite));
        loadSprite("wall", svgToDataURL(wallSprite));
        loadSprite("floor", svgToDataURL(floorSprite));
        loadSprite("treasure", svgToDataURL(treasureSprite));
        loadSprite("potion", svgToDataURL(potionSprite));

        // Scene: Menu
        scene("menu", () => {
            add([
                rect(width(), height()),
                color(20, 20, 30),
                pos(0, 0)
            ]);
            
            add([
                text("DUNGEON MASTER RPG", { size: 48, font: "sink" }),
                pos(width() / 2, height() / 2 - 150),
                anchor("center"),
                color(255, 215, 0)
            ]);
            
            add([
                text("Kaboom.js Edition", { size: 24 }),
                pos(width() / 2, height() / 2 - 100),
                anchor("center"),
                color(255, 255, 255)
            ]);
            
            add([
                text("▶ START GAME", { size: 24 }),
                pos(width() / 2, height() / 2 - 20),
                anchor("center"),
                area(),
                color(255, 255, 255)
            ]);
            
            add([
                text("��� HOW TO PLAY", { size: 24 }),
                pos(width() / 2, height() / 2 + 20),
                anchor("center"),
                area(),
                color(255, 255, 255)
            ]);
            
            add([
                text("⚙️  SETTINGS", { size: 24 }),
                pos(width() / 2, height() / 2 + 60),
                anchor("center"),
                area(),
                color(255, 255, 255)
            ]);
            
            add([
                text("Use WASD to move, SPACE to attack", { size: 16 }),
                pos(width() / 2, height() - 80),
                anchor("center"),
                color(150, 150, 150)
            ]);
            
            onKeyPress("space", () => {
                go("game");
            });
            
            onKeyPress("enter", () => {
                go("game");
            });
            
            onKeyPress("h", () => {
                go("help");
            });
            
            // Mouse support for menu - specific to clickable buttons only
            onClick((obj) => {
                if (obj.is("text") && (
                    obj.text.includes("START GAME") ||
                    obj.text.includes("HOW TO PLAY") ||
                    obj.text.includes("SETTINGS")
                )) {
                    if (obj.text.includes("START GAME")) {
                        go("game");
                    } else if (obj.text.includes("HOW TO PLAY")) {
                        go("help");
                    } else if (obj.text.includes("SETTINGS")) {
                        go("game");
                    }
                }
            });
        });

        // Scene: Help
        scene("help", () => {
            add([
                rect(width(), height()),
                color(20, 20, 30),
                pos(0, 0)
            ]);
            
            add([
                text("HOW TO PLAY", { size: 36 }),
                pos(width() / 2, 50),
                anchor("center"),
                area(),
                color(255, 215, 0)
            ]);
            
            const controls = [
                "��� CONTROLS:",
                "WASD - Move your hero",
                "SPACE - Attack nearby enemies",
                "E - Interact with objects",
                "I - Open inventory",
                "M - View map",
                "",
                "��� COMBAT:",
                "Get close to enemies and press SPACE",
                "Use strategy and positioning",
                "Collect items to increase power",
                "",
                "��� OBJECTIVE:",
                "Explore the dungeon",
                "Defeat monsters",
                "Collect treasure",
                "Level up your character"
            ];
            
            controls.forEach((text, i) => {
                add([
                    text(text, { size: text.startsWith("���") || text.startsWith("���") || text.startsWith("���") ? 20 : 16 }),
                    pos(width() / 2, 120 + i * 25),
                    anchor("center"),
                    area(),
                    color(text.includes("WASD") || text.includes("SPACE") ? [100, 255, 100] : [255, 255, 255])
                ]);
            });
            
            add([
                text("Press SPACE to return to menu", { size: 18 }),
                pos(width() / 2, height() - 50),
                anchor("center"),
                area(),
                color(255, 255, 0)
            ]);
            
            onKeyPress("space", () => {
                go("menu");
            });
            
            // Mouse support for help scene - specific to return text only
            onClick((obj) => {
                if (obj.is("text") && obj.text.includes("Press SPACE to return to menu")) {
                    go("menu");
                }
            });
        });

        // Scene: Game
        scene("game", () => {
            add([
                rect(width(), height()),
                color(20, 20, 30),
                pos(0, 0)
            ]);
            
            if (!window.gameState.hero) {
                window.gameState.hero = generateHero();
            }
            
            // Create dungeon floor
            for (let x = 0; x < width(); x += 32) {
                for (let y = 0; y < height(); y += 32) {
                    add([
                        sprite("floor"),
                        pos(x, y),
                        scale(1),
                        "floor"
                    ]);
                }
            }
            
            // Add walls
            const walls = [
                {x: 200, y: 200}, {x: 232, y: 200}, {x: 264, y: 200},
                {x: 400, y: 300}, {x: 432, y: 300},
                {x: 600, y: 150}, {x: 632, y: 150}, {x: 664, y: 150}, {x: 696, y: 150}
            ];
            
            walls.forEach(wall => {
                add([
                    sprite("wall"),
                    pos(wall.x, wall.y),
                    scale(1),
                    area(),
                    body(),
                    "wall"
                ]);
            });
            
            // Add treasure and potions
            add([
                sprite("treasure"),
                pos(500, 300),
                scale(1),
                area(),
                "treasure"
            ]);
            
            add([
                sprite("potion"),
                pos(300, 400),
                scale(1),
                area(),
                "potion"
            ]);
            
            // Hero
            const hero = add([
                sprite("hero"),
                pos(window.gameState.hero.x, window.gameState.hero.y),
                scale(1.5),
                area(),
                "hero",
                {
                    speed: 120,
                    lastAttack: 0
                }
            ]);
            
            // Monsters
            const monster1 = add([
                sprite("monster"),
                pos(400, 200),
                scale(1.5),
                area(),
                "monster",
                {
                    hp: 50,
                    maxHp: 50,
                    speed: 80,
                    damage: 10,
                    lastAttack: 0
                }
            ]);
            
            const monster2 = add([
                sprite("monster"),
                pos(600, 400),
                scale(1.5),
                area(),
                "monster",
                {
                    hp: 30,
                    maxHp: 30,
                    speed: 60,
                    damage: 8,
                    lastAttack: 0
                }
            ]);
            
            window.gameState.monsters = [monster1, monster2];
            
            // Camera follow
            hero.onUpdate(() => {
                if (window.gameState.cameraLocked) {
                    camPos(hero.pos.x, hero.pos.y);
                }
            });
            
            // Controls
            onKeyDown("a", () => {
                if (hero.pos.x > 0) {
                    hero.move(-hero.speed, 0);
                    window.gameState.hero.x = hero.pos.x;
                }
            });
            
            onKeyDown("d", () => {
                if (hero.pos.x < width() - 32) {
                    hero.move(hero.speed, 0);
                    window.gameState.hero.x = hero.pos.x;
                }
            });
            
            onKeyDown("w", () => {
                if (hero.pos.y > 0) {
                    hero.move(0, -hero.speed);
                    window.gameState.hero.y = hero.pos.y;
                }
            });
            
            onKeyDown("s", () => {
                if (hero.pos.y < height() - 32) {
                    hero.move(0, hero.speed);
                    window.gameState.hero.y = hero.pos.y;
                }
            });
            
            // Attack
            onKeyPress("space", () => {
                const now = Date.now();
                if (now - hero.lastAttack < 500) return;
                hero.lastAttack = now;
                
                window.gameState.monsters.forEach(monster => {
                    if (monster.hp > 0 && distance(hero, monster) < 80) {
                        const damage = Math.floor(Math.random() * 15) + window.gameState.hero.stats.str / 2;
                        monster.hp -= damage;
                        
                        add([
                            text(`-${damage}`, { size: 20 }),
                            pos(monster.pos.x, monster.pos.y - 20),
                            color(255, 0, 0),
                            lifespan(1)
                        ]);
                        
                        shake(5);
                        
                        if (monster.hp <= 0) {
                            add([
                                text("MONSTER DEFEATED!", { size: 24 }),
                                pos(width() / 2, height() / 2),
                                anchor("center"),
                                color(255, 255, 0),
                                lifespan(2)
                            ]);
                            
                            destroy(monster);
                            window.gameState.monsters = window.gameState.monsters.filter(m => m !== monster);
                            window.gameState.hero.xp += 25;
                            
                            if (window.gameState.hero.xp >= window.gameState.hero.level * 100) {
                                window.gameState.hero.level++;
                                window.gameState.hero.maxHp += 20;
                                window.gameState.hero.hp = window.gameState.hero.maxHp;
                                add([
                                    text(`LEVEL UP! Level ${window.gameState.hero.level}`, { size: 28 }),
                                    pos(width() / 2, height() / 2),
                                    anchor("center"),
                                    color(255, 215, 0),
                                    lifespan(3)
                                ]);
                            }
                        }
                    }
                });
            });
            
            // Monster AI
            onUpdate(() => {
                window.gameState.monsters.forEach(monster => {
                    if (monster.hp > 0) {
                        const now = Date.now();
                        if (now - monster.lastAttack > 2000) {
                            monster.lastAttack = now;
                            
                            if (distance(hero, monster) < 80) {
                                const damage = monster.damage;
                                window.gameState.hero.hp -= damage;
                                
                                add([
                                    text(`-${damage}`, { size: 20 }),
                                    pos(hero.pos.x, hero.pos.y - 20),
                                    color(255, 100, 100),
                                    lifespan(1)
                                ]);
                                
                                if (window.gameState.hero.hp <= 0) {
                                    add([
                                        text("GAME OVER!", { size: 48 }),
                                        pos(width() / 2, height() / 2),
                                        anchor("center"),
                                        color(255, 0, 0),
                                        lifespan(3)
                                    ]);
                                    go("menu");
                                }
                            }
                        }
                    }
                });
            });
            
            // Item collection
            onCollide("hero", "treasure", (hero, treasure) => {
                destroy(treasure);
                const item = getRandomItem(gameData.items);
                window.gameState.hero.inventory.push(item);
                
                add([
                    text(`Found: ${item.name}!`, { size: 20 }),
                    pos(hero.pos.x, hero.pos.y - 30),
                    color(255, 215, 0),
                    lifespan(2)
                ]);
            });
            
            onCollide("hero", "potion", (hero, potion) => {
                destroy(potion);
                const healing = 30;
                window.gameState.hero.hp = Math.min(window.gameState.hero.maxHp, window.gameState.hero.hp + healing);
                
                add([
                    text(`+${healing} HP!`, { size: 20 }),
                    pos(hero.pos.x, hero.pos.y - 30),
                    color(0, 255, 0),
                    lifespan(2)
                ]);
            });
        });

        // Start game
        go("menu");

        // Debug info
        onUpdate(() => {
            if (window.gameState.hero) {
                debug.log(`Hero: ${window.gameState.hero.name} | HP: ${window.gameState.hero.hp}/${window.gameState.hero.maxHp} | XP: ${window.gameState.hero.xp} | Level: ${window.gameState.hero.level}`);
            }
        });

        // Update UI
        onUpdate(() => {
            document.getElementById('fps').textContent = Math.round(debug.fps());
            document.getElementById('objects').textContent = get('*').length;
        });

        // Update hero stats
        setInterval(() => {
            const statsDiv = document.getElementById('heroStats');
            const hero = window.gameState?.hero;
            
            if (hero) {
                statsDiv.innerHTML = `
                    <div><span class="text-green-400">${hero.name}</span></div>
                    <div><span class="text-blue-400">${hero.race} ${hero.characterClass}</span></div>
                    <div><span class="text-yellow-400">Level ${hero.level}</span></div>
                    <div><span class="text-purple-400">XP: ${hero.xp}</span></div>
                    <div><span class="text-cyan-400">Inventory: ${hero.inventory.length}</span></div>
                `;
                
                const hpPercent = hero.hp / hero.maxHp;
                document.getElementById('healthFill').style.width = `${hpPercent * 100}%`;
                document.getElementById('healthText').textContent = `${Math.floor(hero.hp)}/${hero.maxHp}`;
                
                const mpPercent = hero.mp / hero.maxMp;
                document.getElementById('manaFill').style.width = `${mpPercent * 100}%`;
                document.getElementById('manaText').textContent = `${Math.floor(hero.mp)}/${hero.maxMp}`;
                
                const healthFill = document.getElementById('healthFill');
                if (hpPercent > 0.6) {
                    healthFill.style.background = 'linear-gradient(90deg, #00ff00, #88ff00, #ffff00)';
                } else if (hpPercent > 0.3) {
                    healthFill.style.background = 'linear-gradient(90deg, #ff8800, #ffaa00, #ffff00)';
                } else {
                    healthFill.style.background = 'linear-gradient(90deg, #ff0000, #ff4400, #ff8800)';
                }
            }
        }, 500);

        console.log('��� Dungeon Master RPG loaded with Kaboom.js - CORS FREE!');
        console.log('��� Use WASD to move, SPACE to attack!');
    </script>
</body>
</html>
